<!DOCTYPE HTML>
<html>
<head>
    <title>Quiz4</title>
</head>
<style>
    td{
        border: 1px solid black;
        text-align: center;
        margin: auto;
    }
    select{
        display: none;
        text-align: center;
    }
    #WelcomeScreen{
        display: block;
    }
    #CreateGameScreen{
        display: none;
    }
    #JoinGameScreen{
        display: none;
    }
    #LobbyScreen{
        display: none;
    }
    .LobbyPlayerNameBox{
        min-width: 150px;
    }
    .LobbyPlayerTeamBox{
        min-width: 150px;
    }
    #GameScreen{
        display: none;
    }
    #GameInfoScreen{
        display:inline-block;
        vertical-align: top;
        width:394px;
    }
    #GameBoardScreen{
        display:inline-block;
        vertical-align: top;
        border: 1px solid black;
    }
    .Slot{
        min-width: 50px;
        height: 50px;
        border-radius: 50px;
        background-color: white;
    }
    #GameTextScreen{
        height: 230px;
        border: 1px solid black;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    #GameScoreboard{
        width: 100%;
    }
    .GamePlayerNameBox{
        font-weight: bold;
        width: calc(100%-50px);
    }
    .GamePlayerScoreBox{
        width: 50px;
        min-width: 50px;
    }
</style>
<script src="/socket.io/socket.io.js"></script>
<script>
var socket;
var welcomeScreen;
var createGameScreen;
var joinGameScreen;
var lobbyScreen;
var gameScreen;
var currentScreen;
var gameSlotMatrix = new Array(7);
var gameHeader;
var gameTimer;
var answerBox;
var playAgainButton;
var gameIteration = -1;
var gamePhase;
var coinMatrix = new Array(7);
var coinStatus = 1;

function init(){
    welcomeScreen = document.getElementById('WelcomeScreen');
    createGameScreen = document.getElementById('CreateGameScreen');
    joinGameScreen = document.getElementById('JoinGameScreen');
    lobbyScreen = document.getElementById('LobbyScreen');
    gameScreen = document.getElementById('GameScreen');
    answerBox = document.getElementById('AnswerBox');
    playAgainButton = document.getElementById('PlayAgainButton');
    currentScreen = welcomeScreen;
    initSocket();
    initGameSlots();
}

function initSocket(){
    socket = io();
    
    socket.on('errorMessage', function(message){
        alert("Error: "+message);
    });
    
    socket.on('joinLobby', function(lobby){
        enterLobbyScreen(lobby);
    });
    
    socket.on('updateLobby', function(lobby){
        updateLobby(lobby);
    });
    
    socket.on('joinGame', function(game){
        enterGameScreen(game);
    });
    
    socket.on('updateGame', function(game){
       updateGame(game);
    });
    
    socket.on('updateGameText', function(phase, extra){
       updateGameText(phase, extra);
    });
    
    socket.on('wrongAnswer', function(answer){
        updateGameText("WrongAnswer", answer)
    });
    
    socket.on('changeTimer', function(time, iteration){
        updateTimer(time, iteration);
    });
    
    socket.on('coinDrop', function(x, y, color){
        placeCoin(x, y, color);
    });
    
    window.onkeyup = function(e) {
        var key = e.keyCode ? e.keyCode : e.which;
        if(key == 13 && answerBox.style.display == "inline-block" && answerBox.value != ""){
            socket.emit('submitAnswer', answerBox.value);
        }
    }
}

function initGameSlots(){
    for(var x = 0; x < 7; x++){
        gameSlotMatrix[x] = new Array(6);
        for(var y = 0; y < 6; y++){
            gameSlotMatrix[x][y] = document.getElementById("Slot"+x+"-"+y);
        }
    }
}

function initCoinMatrix(){
    for(var x = 0; x < 7; x++){
        coinMatrix[x] = new Array(6);
        for(var y = 0; y < 6; y++){
            coinMatrix[x][y] = -1;
        }
    }
}

function changeScreen(newScreen){
    currentScreen.style.display = "none";
    newScreen.style.display = "block";
    currentScreen = newScreen;
}

function newGameRequest(){
    var nameBox = document.getElementById('NameBox');
    var name = nameBox.value;
    if(name.length == 0){
        alert("Please enter a name!")
    }
    else{
        socket.emit('newGameRequest', name);
    }
}

function joinGameRequest(){
    var nameBox = document.getElementById('NameBoxJoin');
    var name = nameBox.value;
    if(name.length == 0){
        alert("Please enter a name!")
    }
    else{
        var gameCodeBox = document.getElementById('GameCodeBox');
        var gameCode = gameCodeBox.value;
        if(gameCode.length != 6){
            alert("Please enter a valid six letter game code!")
        }
        else{
            socket.emit('joinGameRequest', gameCode.toUpperCase(), name);
        }
    }
}

function enterLobbyScreen(lobby){
    changeScreen(lobbyScreen);
    updateLobby(lobby);
}

function updateLobby(lobby){
    var gameCodeLabel = document.getElementById("GameCodeLabel");
    gameCodeLabel.innerHTML = "Game Code: "+lobby.gameCode;
    for(var playerIndex = 0; playerIndex < 4; playerIndex++){
        var playerLabel = document.getElementById("Player"+playerIndex+"Label");
        var playerTeamSelect = document.getElementById("Player"+playerIndex+"Team");
        if(playerIndex < lobby.players.length){
            playerLabel.innerHTML = lobby.players[playerIndex];
            playerTeamSelect.style.display = "inline-block";
            if(lobby.teams[playerIndex] != ""){
                playerTeamSelect.value = lobby.teams[playerIndex];
                playerTeamSelect.style.backgroundColor = lobby.teams[playerIndex].toLowerCase();
            }
            else{
                playerTeamSelect.selectedIndex = 0;
                playerTeamSelect.style.backgroundColor = "white"
            }
        }
        else{
            playerLabel.innerHTML = "&nbsp;";
            playerTeamSelect.style.display = "none";
        }
    }
}

function changeTeamRequest(playerIndex){
    var playerTeam = document.getElementById("Player"+playerIndex+"Team");
    socket.emit('changeTeamRequest', playerIndex, playerTeam.value);
}

function leaveLobby(){
    socket.emit('leaveLobby');
    changeScreen(welcomeScreen);
}

function startGameRequest(){
    socket.emit('startGameRequest');
}

function enterGameScreen(game){
    gameHeader = document.getElementById("GameHeader");
    gameTimer = document.getElementById("GameTimer");
    answerBox = document.getElementById("AnswerBox");
    gameIteration = -1;
    initCoinMatrix();
    for(var x = 0; x < 7; x++){
        for(var y = 0; y < 6; y++){
            gameSlotMatrix[x][y].style.backgroundColor = "white";
        }
    }
    changeScreen(gameScreen);
    updateGame(game);
}

function updateGame(game){
    for(var playerIndex = 0; playerIndex < 4; playerIndex++){
        var playerNameBox = document.getElementById("GamePlayer"+playerIndex+"NameBox");
        var playerScoreBox = document.getElementById("GamePlayer"+playerIndex+"ScoreBox");
        if(playerIndex < game.players.length){
            playerNameBox.innerHTML = game.players[playerIndex];
            playerScoreBox.innerHTML = game.scores[playerIndex];
            if(game.statuses[playerIndex] != -1){
                playerNameBox.style.backgroundColor = game.teams[playerIndex].toLowerCase();
                playerScoreBox.style.backgroundColor = "white";
            }
            else{
                playerNameBox.style.backgroundColor = "gray";
                playerScoreBox.style.backgroundColor = "gray";
            }
        }
        else{
            var playerInfoBox = document.getElementById("GamePlayer"+playerIndex+"InfoBox");
            playerInfoBox.style.display = "none";
        }
    }
}

function updateGameText(phase, extra){
    gamePhase = phase;
    if(phase != "Question"){
        answerBox.style.display = "none";
        answerBox.value = "";
    }
    else{
        answerBox.style.display = "inline-block";
    }
    if(phase != "GameWon"){
        gameTimer.style.display = "inline-block";
        playAgainButton.style.display = "none";
    }
    else{
        gameTimer.style.display = "none";
        playAgainButton.style.display = "inline-block";
    }
    if(phase == "WelcomeCountdown"){
        gameHeader.innerHTML = "Welcome! Get ready for the first question...";
    }
    else if(phase == "Question"){
        gameHeader.innerHTML = extra;
    }
    else if(phase == "QuestionCountdown"){
        gameHeader.innerHTML = "Get ready for the next question...";
    }
    else if(phase == "NoCorrectCountdown"){
        gameHeader.innerHTML = "No one got the correct answer: "+extra+"! Get ready for the next question...";
    }
    else if(phase == "CoinDropCountdown"){
        gameHeader.innerHTML = extra.correctAnswerer+" got the correct answer: "+extra.answer+". Waiting for them to drop a coin...";
    }
    else if(phase == "CoinDrop"){
        gameHeader.innerHTML = "You got the correct answer: "+extra+"! Please drop a coin...";
    }
    else if(phase == "WrongAnswer"){
        gameHeader.innerHTML = "Incorrect answer! The right answer was "+extra+".";
    }
    else if(phase == "GameWon"){
        if(extra.length == 0){
            gameHeader.innerHTML = "It's a draw! Everyone wins!";
        }
        else{
            var winString = "";
            for(var winnerIndex = 0; winnerIndex < extra.length; winnerIndex++){
                winString += extra[winnerIndex]
                if(winnerIndex < extra.length-1){
                    winString += " & ";
                }
            }
            if(extra.length > 1){
                winString += " win!";
            }
            else{
                winString += " wins!";
            }
            gameHeader.innerHTML = winString;
        }
    }
}

function updateTimer(time, iteration){
    if(iteration >= gameIteration && time >= 0){
        gameIteration = iteration;
        if(time < 10){
            gameTimer.innerHTML = "0:0"+time;
        }
        else{
            gameTimer.innerHTML = "0:"+time;
        }
        setTimeout(function(){updateTimer(time-1, iteration);}, 1000);
    }
}

function leaveGame(){
    socket.emit('leaveGame');
    var gameIteration = -1;
    changeScreen(welcomeScreen);
}

function hoverSlot(x, y){
}

function clickSlot(x, y){
    if(gamePhase == "CoinDrop"){
        socket.emit('placeCoin', x, y);
    }
}

function placeCoin(x, y, color){
    if(coinMatrix[x][5] == -1){
        coinMatrix[x][5] = color;
        gameSlotMatrix[x][5].style.backgroundColor = color;
        setTimeout(function(){ coinFall(x, 5); }, 50);
    }
}

function coinFall(x, y){
    if(y == 0 || coinMatrix[x][y-1] != -1){
        checkWinner(x, y);
    }
    else{
        gameSlotMatrix[x][y-1].style.backgroundColor = gameSlotMatrix[x][y].style.backgroundColor;
        gameSlotMatrix[x][y].style.backgroundColor = "white";
        coinMatrix[x][y-1] = coinMatrix[x][y];
        coinMatrix[x][y] = -1;
        setTimeout(function(){ coinFall(x, y-1); }, 50);
        
    }
}

function checkWinner(x, y){
    var directionsArray = [{dX: 1, dY: 0}, {dX: 0, dY: 1}, {dX: 1, dY: -1}, {dX: 1, dY: 1}];
    for(var directionIndex = 0; directionIndex < directionsArray.length; directionIndex++){
        var currentDirection = directionsArray[directionIndex];
        var directionNeighborCount = countSameNeighbors(x, y, currentDirection.dX, currentDirection.dY);
        var compDirectionNeighborCount = countSameNeighbors(x, y, -currentDirection.dX, -currentDirection.dY);
        if(directionNeighborCount + compDirectionNeighborCount >= 3){
            gameSlotMatrix[x][y].style.backgroundColor = "yellow";
            highlightNeighbors(x, y, currentDirection.dX, currentDirection.dY, directionNeighborCount);
            highlightNeighbors(x, y, -currentDirection.dX, -currentDirection.dY, compDirectionNeighborCount);
        }
    }
}

function countSameNeighbors(x, y, dX, dY){
    var coinValue = coinMatrix[x][y];
    var neighborCount = 0;
    var neighborX = x+dX;
    var neighborY = y+dY;
    while(neighborX >= 0 && neighborY >= 0 && neighborX < 7 && neighborY < 6 && coinMatrix[neighborX][neighborY] == coinValue){
        neighborCount += 1;
        neighborX += dX;
        neighborY += dY;
    }
    return neighborCount;
}

function highlightNeighbors(x, y, dX, dY, neighborCount){
    var neighborX = x+dX;
    var neighborY = y+dY;
    while(neighborX >= 0 && neighborY >= 0 && neighborX < 7 && neighborY < 6 && neighborCount > 0){
        gameSlotMatrix[neighborX][neighborY].style.backgroundColor = "yellow";
        neighborCount -= 1;
        neighborX += dX;
        neighborY += dY;
    }
}

function playAgainRequest(){
    alert("PLAY AGAIN!");
}

function endGameRequest(){
    alert("END GAME!");
}

</script>
<body onload="init()">
    <center>
    <h1>Quiz4</h1>
    <div id="WelcomeScreen">
        <button type="button" onclick="changeScreen(createGameScreen)">New Game</button>
        <button type="button" onclick="changeScreen(joinGameScreen)">Join Game</button>
    </div>
    <div id="CreateGameScreen">
        <input type="text" id="NameBox" placeholder="Enter your name"><br>
        <button type="button" onclick="newGameRequest()">Create Game</button>
        <button type="button" onclick="changeScreen(welcomeScreen)">Back</button>
    </div>
    <div id="JoinGameScreen">
        <input type="text" id="GameCodeBox" placeholder="Enter a game code"><br>
        <input type="text" id="NameBoxJoin" placeholder="Enter your name"><br>
        <button type="button" onclick="joinGameRequest()">Join Game</button>
        <button type="button" onclick="changeScreen(welcomeScreen)">Back</button>
    </div>
    <div id="LobbyScreen">
        <h2 id="GameCodeLabel">Game Code:</h2>
        <table>
            <tr><td class="LobbyPlayerNameBox"><strong>Player</strong></td><td class="LobbyPlayerTeamBox"><strong>Team</strong></td></tr>
            <tr>
                <td id="Player0Label" class="LobbyPlayerNameBox">&nbsp;</td>
                <td class="LobbyPlayerTeamBox">
                    <select onchange="changeTeamRequest(0)" id="Player0Team">
                        <option disabled selected>Select a team</option>
                        <option>Red</option>
                        <option>Orange</option>
                        <option>Yellow</option>
                        <option>Green</option>
                        <option>Blue</option>
                        <option>Purple</option>
                        <option>Pink</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td id="Player1Label" class="LobbyPlayerNameBox">&nbsp;</td>
                <td class="LobbyPlayerTeamBox">
                    <select onchange="changeTeamRequest(1)" id="Player1Team">
                        <option disabled selected>Select a team</option>
                        <option>Red</option>
                        <option>Orange</option>
                        <option>Yellow</option>
                        <option>Green</option>
                        <option>Blue</option>
                        <option>Purple</option>
                        <option>Pink</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td id="Player2Label" class="LobbyPlayerNameBox">&nbsp;</td>
                <td class="LobbyPlayerTeamBox">
                    <select onchange="changeTeamRequest(2)" id="Player2Team">
                        <option disabled selected>Select a team</option>
                        <option>Red</option>
                        <option>Orange</option>
                        <option>Yellow</option>
                        <option>Green</option>
                        <option>Blue</option>
                        <option>Purple</option>
                        <option>Pink</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td id="Player3Label" class="LobbyPlayerNameBox">&nbsp;</td>
                <td class="LobbyPlayerTeamBox">
                    <select onchange="changeTeamRequest(3)" id="Player3Team">
                        <option disabled selected>Select a team</option>
                        <option>Red</option>
                        <option>Orange</option>
                        <option>Yellow</option>
                        <option>Green</option>
                        <option>Blue</option>
                        <option>Purple</option>
                        <option>Pink</option>
                    </select>
                </td>
            </tr>
        </table>
        <button type="button" onclick="startGameRequest()">Start Game</button>
        <button type="button" onclick="leaveLobby()">Back</button>
    </div>
    <div id="GameScreen">
        <div id="GameInfoScreen">
            <div id="GameTextScreen">
                <h2 id="GameHeader">Welcome!</h2>
                <input type="text" id="AnswerBox" placeholder="Enter your answer">
                <h2 id="GameTimer">0:00</h2>
                <button type="button" id="PlayAgainButton" onclick="playAgainRequest()">Play Again</button>
            </div>
            <table id="GameScoreboard">
            <tr id="GamePlayer0InfoBox"><td id="GamePlayer0NameBox" class="GamePlayerNameBox">Player 0</td><td id="GamePlayer0ScoreBox" class="GamePlayerScoreBox">0</td><tr>
            <tr id="GamePlayer1InfoBox"><td id="GamePlayer1NameBox" class="GamePlayerNameBox">Player 1</td><td id="GamePlayer1ScoreBox" class="GamePlayerScoreBox">0</td><tr>
            <tr id="GamePlayer2InfoBox"><td id="GamePlayer2NameBox" class="GamePlayerNameBox">Player 2</td><td id="GamePlayer2ScoreBox" class="GamePlayerScoreBox">0</td><tr>
            <tr id="GamePlayer3InfoBox"><td id="GamePlayer3NameBox" class="GamePlayerNameBox">Player 3</td><td id="GamePlayer3ScoreBox" class="GamePlayerScoreBox">0</td><tr>
            </table>
        </div>
        <table id="GameBoardScreen">
            <tr>
                <td class="Slot" id="Slot0-5" onmouseover="hoverSlot(0, 5)" onclick="clickSlot(0, 5)">&nbsp;</td>
                <td class="Slot" id="Slot1-5" onmouseover="hoverSlot(1, 5)" onclick="clickSlot(1, 5)">&nbsp;</td>
                <td class="Slot" id="Slot2-5" onmouseover="hoverSlot(2, 5)" onclick="clickSlot(2, 5)">&nbsp;</td>
                <td class="Slot" id="Slot3-5" onmouseover="hoverSlot(3, 5)" onclick="clickSlot(3, 5)">&nbsp;</td>
                <td class="Slot" id="Slot4-5" onmouseover="hoverSlot(4, 5)" onclick="clickSlot(4, 5)">&nbsp;</td>
                <td class="Slot" id="Slot5-5" onmouseover="hoverSlot(5, 5)" onclick="clickSlot(5, 5)">&nbsp;</td>
                <td class="Slot" id="Slot6-5" onmouseover="hoverSlot(6, 5)" onclick="clickSlot(6, 5)">&nbsp;</td>
            </tr>
            <tr>
                <td class="Slot" id="Slot0-4" onmouseover="hoverSlot(0, 4)" onclick="clickSlot(0, 4)">&nbsp;</td>
                <td class="Slot" id="Slot1-4" onmouseover="hoverSlot(1, 4)" onclick="clickSlot(1, 4)">&nbsp;</td>
                <td class="Slot" id="Slot2-4" onmouseover="hoverSlot(2, 4)" onclick="clickSlot(2, 4)">&nbsp;</td>
                <td class="Slot" id="Slot3-4" onmouseover="hoverSlot(3, 4)" onclick="clickSlot(3, 4)">&nbsp;</td>
                <td class="Slot" id="Slot4-4" onmouseover="hoverSlot(4, 4)" onclick="clickSlot(4, 4)">&nbsp;</td>
                <td class="Slot" id="Slot5-4" onmouseover="hoverSlot(5, 4)" onclick="clickSlot(5, 4)">&nbsp;</td>
                <td class="Slot" id="Slot6-4" onmouseover="hoverSlot(6, 4)" onclick="clickSlot(6, 4)">&nbsp;</td>
            </tr>
            <tr>
                <td class="Slot" id="Slot0-3" onmouseover="hoverSlot(0, 3)" onclick="clickSlot(0, 3)">&nbsp;</td>
                <td class="Slot" id="Slot1-3" onmouseover="hoverSlot(1, 3)" onclick="clickSlot(1, 3)">&nbsp;</td>
                <td class="Slot" id="Slot2-3" onmouseover="hoverSlot(2, 3)" onclick="clickSlot(2, 3)">&nbsp;</td>
                <td class="Slot" id="Slot3-3" onmouseover="hoverSlot(3, 3)" onclick="clickSlot(3, 3)">&nbsp;</td>
                <td class="Slot" id="Slot4-3" onmouseover="hoverSlot(4, 3)" onclick="clickSlot(4, 3)">&nbsp;</td>
                <td class="Slot" id="Slot5-3" onmouseover="hoverSlot(5, 3)" onclick="clickSlot(5, 3)">&nbsp;</td>
                <td class="Slot" id="Slot6-3" onmouseover="hoverSlot(6, 3)" onclick="clickSlot(6, 3)">&nbsp;</td>
            </tr>
            <tr>
                <td class="Slot" id="Slot0-2" onmouseover="hoverSlot(0, 2)" onclick="clickSlot(0, 2)">&nbsp;</td>
                <td class="Slot" id="Slot1-2" onmouseover="hoverSlot(1, 2)" onclick="clickSlot(1, 2)">&nbsp;</td>
                <td class="Slot" id="Slot2-2" onmouseover="hoverSlot(2, 2)" onclick="clickSlot(2, 2)">&nbsp;</td>
                <td class="Slot" id="Slot3-2" onmouseover="hoverSlot(3, 2)" onclick="clickSlot(3, 2)">&nbsp;</td>
                <td class="Slot" id="Slot4-2" onmouseover="hoverSlot(4, 2)" onclick="clickSlot(4, 2)">&nbsp;</td>
                <td class="Slot" id="Slot5-2" onmouseover="hoverSlot(5, 2)" onclick="clickSlot(5, 2)">&nbsp;</td>
                <td class="Slot" id="Slot6-2" onmouseover="hoverSlot(6, 2)" onclick="clickSlot(6, 2)">&nbsp;</td>
            </tr>
            <tr>
                <td class="Slot" id="Slot0-1" onmouseover="hoverSlot(0, 1)" onclick="clickSlot(0, 1)">&nbsp;</td>
                <td class="Slot" id="Slot1-1" onmouseover="hoverSlot(1, 1)" onclick="clickSlot(1, 1)">&nbsp;</td>
                <td class="Slot" id="Slot2-1" onmouseover="hoverSlot(2, 1)" onclick="clickSlot(2, 1)">&nbsp;</td>
                <td class="Slot" id="Slot3-1" onmouseover="hoverSlot(3, 1)" onclick="clickSlot(3, 1)">&nbsp;</td>
                <td class="Slot" id="Slot4-1" onmouseover="hoverSlot(4, 1)" onclick="clickSlot(4, 1)">&nbsp;</td>
                <td class="Slot" id="Slot5-1" onmouseover="hoverSlot(5, 1)" onclick="clickSlot(5, 1)">&nbsp;</td>
                <td class="Slot" id="Slot6-1" onmouseover="hoverSlot(6, 1)" onclick="clickSlot(6, 1)">&nbsp;</td>
            </tr>
            <tr>
                <td class="Slot" id="Slot0-0" onmouseover="hoverSlot(0, 0)" onclick="clickSlot(0, 0)">&nbsp;</td>
                <td class="Slot" id="Slot1-0" onmouseover="hoverSlot(1, 0)" onclick="clickSlot(1, 0)">&nbsp;</td>
                <td class="Slot" id="Slot2-0" onmouseover="hoverSlot(2, 0)" onclick="clickSlot(2, 0)">&nbsp;</td>
                <td class="Slot" id="Slot3-0" onmouseover="hoverSlot(3, 0)" onclick="clickSlot(3, 0)">&nbsp;</td>
                <td class="Slot" id="Slot4-0" onmouseover="hoverSlot(4, 0)" onclick="clickSlot(4, 0)">&nbsp;</td>
                <td class="Slot" id="Slot5-0" onmouseover="hoverSlot(5, 0)" onclick="clickSlot(5, 0)">&nbsp;</td>
                <td class="Slot" id="Slot6-0" onmouseover="hoverSlot(6, 0)" onclick="clickSlot(6, 0)">&nbsp;</td>
            </tr>
        </table><br>
        <button type="button" onclick="leaveGame()">Leave Game</button>
        <button type="button" onclick="endGameRequest()">End Game</button>
    </div>
    </center>
</body>
</html>
